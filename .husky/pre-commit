#!/usr/bin/env sh

# Run lint-staged
npx lint-staged

# Scan staged files for secrets
SECRETS_FOUND=0
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

for FILE in $STAGED_FILES; do
  # Skip binary files and lock files
  case "$FILE" in
    *.lock|*.png|*.jpg|*.pdf|*.docx|*.xlsx) continue ;;
  esac

  # Check for common secret patterns
  if git show ":$FILE" 2>/dev/null | grep -qE '(sk-[a-zA-Z0-9]{20,}|AKIA[0-9A-Z]{16}|ghp_[a-zA-Z0-9]{36}|GOCSPX-[a-zA-Z0-9_-]+|-----BEGIN (RSA |EC )?PRIVATE KEY)'; then
    echo "ERROR: Possible secret found in $FILE"
    SECRETS_FOUND=1
  fi
done

if [ "$SECRETS_FOUND" -eq 1 ]; then
  echo ""
  echo "Commit blocked: potential secrets detected in staged files."
  echo "Remove secrets and use environment variables instead."
  exit 1
fi
