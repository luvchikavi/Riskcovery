generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CORE ENTITIES ====================

model Organization {
  id        String   @id @default(uuid())
  name      String
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users                User[]
  vendors              Vendor[]
  requirementTemplates RequirementTemplate[]
  rfqClients           RfqClient[]

  @@map("organizations")
}

model User {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String   @unique
  name           String?
  role           UserRole
  phone          String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization         @relation(fields: [organizationId], references: [id])
  verifiedDocs Document[]           @relation("VerifiedBy")
  tasks        VerificationTask[]
  auditLogs    AuditLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  COMPLIANCE_MANAGER
  CONTRACT_MANAGER
  REVIEWER
  EXPERT_REVIEWER
}

model Vendor {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  name           String
  email          String?
  phone          String?
  vendorType     String?      @map("vendor_type")
  companyId      String?      @map("company_id")
  status         VendorStatus @default(PENDING)
  magicLinkToken String?      @map("magic_link_token")
  tokenExpiresAt DateTime?    @map("token_expires_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization      Organization       @relation(fields: [organizationId], references: [id])
  contracts         Contract[]
  documents         Document[]
  requirements      VendorRequirement[]
  complianceResults ComplianceResult[]

  @@map("vendors")
}

enum VendorStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ==================== DOCUMENTS & OCR ====================

model Document {
  id           String         @id @default(uuid())
  vendorId     String         @map("vendor_id")
  fileName     String         @map("file_name")
  originalName String         @map("original_name")
  s3Key        String         @map("s3_key")
  fileSize     Int            @map("file_size")
  mimeType     String         @map("mime_type")
  status       DocumentStatus @default(UPLOADED)
  aiConfidence Float?         @map("ai_confidence")
  ocrProvider  String?        @map("ocr_provider")
  ocrRawText   String?        @map("ocr_raw_text")
  verifiedBy   String?        @map("verified_by")
  verifiedAt   DateTime?      @map("verified_at")
  createdAt    DateTime       @default(now()) @map("created_at")

  vendor    Vendor             @relation(fields: [vendorId], references: [id])
  verifier  User?              @relation("VerifiedBy", fields: [verifiedBy], references: [id])
  coverages ExtractedCoverage[]
  tasks     VerificationTask[]

  @@map("documents")
}

enum DocumentStatus {
  UPLOADED
  PROCESSING
  AI_COMPLETE
  REVIEW_NEEDED
  VERIFIED
  REJECTED
}

model ExtractedCoverage {
  id                  String    @id @default(uuid())
  documentId          String    @map("document_id")
  policyType          String    @map("policy_type")
  policyNumber        String?   @map("policy_number")
  insurerName         String?   @map("insurer_name")
  insuredName         String?   @map("insured_name")
  effectiveDate       DateTime? @map("effective_date")
  expirationDate      DateTime? @map("expiration_date")
  limitAmount         Decimal?  @map("limit_amount")
  currency            String    @default("ILS")
  deductible          Decimal?
  endorsements        Json      @default("[]")
  additionalInsured   Boolean   @default(false) @map("additional_insured")
  waiverOfSubrogation Boolean   @default(false) @map("waiver_of_subrogation")
  aiConfidence        Float?    @map("ai_confidence")
  fieldConfidences    Json?     @map("field_confidences")
  isVerified          Boolean   @default(false) @map("is_verified")
  verifiedAt          DateTime? @map("verified_at")
  createdAt           DateTime  @default(now()) @map("created_at")

  document          Document           @relation(fields: [documentId], references: [id])
  complianceResults ComplianceResult[]

  @@map("extracted_coverages")
}

// ==================== REQUIREMENTS & COMPLIANCE ====================

model RequirementTemplate {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  vendorType     String?  @map("vendor_type")
  isDefault      Boolean  @default(false) @map("is_default")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization          @relation(fields: [organizationId], references: [id])
  requirements TemplateRequirement[]

  @@map("requirement_templates")
}

model TemplateRequirement {
  id                   String   @id @default(uuid())
  templateId           String   @map("template_id")
  policyType           String   @map("policy_type")
  minLimit             Decimal? @map("min_limit")
  currency             String   @default("ILS")
  requiredEndorsements Json     @default("[]") @map("required_endorsements")
  isMandatory          Boolean  @default(true) @map("is_mandatory")
  notes                String?

  template RequirementTemplate @relation(fields: [templateId], references: [id])

  @@map("template_requirements")
}

model VendorRequirement {
  id                   String    @id @default(uuid())
  vendorId             String    @map("vendor_id")
  contractId           String?   @map("contract_id")
  policyType           String    @map("policy_type")
  minLimit             Decimal?  @map("min_limit")
  currency             String    @default("ILS")
  requiredEndorsements Json      @default("[]") @map("required_endorsements")
  isMandatory          Boolean   @default(true) @map("is_mandatory")
  notes                String?
  createdAt            DateTime  @default(now()) @map("created_at")

  vendor            Vendor             @relation(fields: [vendorId], references: [id])
  contract          Contract?          @relation(fields: [contractId], references: [id])
  complianceResults ComplianceResult[]

  @@map("vendor_requirements")
}

model ComplianceResult {
  id            String           @id @default(uuid())
  vendorId      String           @map("vendor_id")
  requirementId String           @map("requirement_id")
  coverageId    String?          @map("coverage_id")
  status        ComplianceStatus
  gapDetails    Json?            @map("gap_details")
  checkedAt     DateTime         @default(now()) @map("checked_at")

  vendor      Vendor             @relation(fields: [vendorId], references: [id])
  requirement VendorRequirement  @relation(fields: [requirementId], references: [id])
  coverage    ExtractedCoverage? @relation(fields: [coverageId], references: [id])

  @@map("compliance_results")
}

enum ComplianceStatus {
  COMPLIANT
  WARNING
  NON_COMPLIANT
  PENDING
}

// ==================== CONTRACTS ====================

model Contract {
  id             String    @id @default(uuid())
  vendorId       String    @map("vendor_id")
  contractNumber String?   @map("contract_number")
  title          String?
  startDate      DateTime? @map("start_date")
  endDate        DateTime? @map("end_date")
  insuranceTerms Json?     @map("insurance_terms")
  documentUrl    String?   @map("document_url")
  status         String    @default("active")
  createdAt      DateTime  @default(now()) @map("created_at")

  vendor       Vendor              @relation(fields: [vendorId], references: [id])
  requirements VendorRequirement[]

  @@map("contracts")
}

// ==================== VERIFICATION ====================

model VerificationTask {
  id          String       @id @default(uuid())
  documentId  String       @map("document_id")
  assignedTo  String?      @map("assigned_to")
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)
  slaDeadline DateTime?    @map("sla_deadline")
  startedAt   DateTime?    @map("started_at")
  completedAt DateTime?    @map("completed_at")
  notes       String?
  createdAt   DateTime     @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id])
  assignee User?    @relation(fields: [assignedTo], references: [id])

  @@map("verification_tasks")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  ESCALATED
}

// ==================== RFQ MODULE ====================

model RfqClient {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  companyId      String?  @map("company_id")
  sector         String
  subSector      String?  @map("sub_sector")
  employeeCount  Int?     @map("employee_count")
  annualRevenue  Decimal? @map("annual_revenue")
  riskProfile    Json?    @map("risk_profile")
  contactName    String?  @map("contact_name")
  contactEmail   String?  @map("contact_email")
  contactPhone   String?  @map("contact_phone")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization   Organization       @relation(fields: [organizationId], references: [id])
  questionnaires RfqQuestionnaire[]
  documents      RfqDocument[]

  @@map("rfq_clients")
}

model RfqQuestionnaire {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  answers   Json
  status    String   @default("draft")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client RfqClient @relation(fields: [clientId], references: [id])

  @@map("rfq_questionnaires")
}

model RfqDocument {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  fileName  String   @map("file_name")
  s3Key     String   @map("s3_key")
  format    String
  createdAt DateTime @default(now()) @map("created_at")

  client RfqClient @relation(fields: [clientId], references: [id])

  @@map("rfq_documents")
}

model InsuranceKnowledgeBase {
  id                 String   @id @default(uuid())
  sector             String
  policyType         String   @map("policy_type")
  policyTypeHe       String   @map("policy_type_he")
  recommendedLimit   Decimal? @map("recommended_limit")
  isMandatory        Boolean  @default(false) @map("is_mandatory")
  commonEndorsements Json     @default("[]") @map("common_endorsements")
  riskFactors        Json     @default("[]") @map("risk_factors")
  description        String?
  descriptionHe      String?  @map("description_he")
  createdAt          DateTime @default(now()) @map("created_at")

  @@unique([sector, policyType])
  @@map("insurance_knowledge_base")
}

// ==================== COMPARISON MODULE ====================

model ComparisonDocument {
  id            String    @id @default(uuid())
  fileName      String    @map("file_name")
  originalName  String    @map("original_name")
  mimeType      String    @map("mime_type")
  size          Int
  s3Key         String    @map("s3_key")
  status        String    @default("uploaded")
  extractedData Json?     @map("extracted_data")
  uploadedAt    DateTime  @default(now()) @map("uploaded_at")
  processedAt   DateTime? @map("processed_at")
  vendorId      String?   @map("vendor_id")
  clientId      String?   @map("client_id")

  comparisons ComparisonAnalysis[]

  @@map("comparison_documents")
}

model ComparisonTemplate {
  id            String   @id @default(uuid())
  name          String
  nameHe        String   @map("name_he")
  description   String?
  descriptionHe String?  @map("description_he")
  sector        String?
  contractType  String?  @map("contract_type")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  requirements ComparisonRequirement[]
  analyses     ComparisonAnalysis[]

  @@map("comparison_templates")
}

model ComparisonRequirement {
  id                       String   @id @default(uuid())
  templateId               String   @map("template_id")
  policyType               String   @map("policy_type")
  policyTypeHe             String   @map("policy_type_he")
  minimumLimit             Decimal  @map("minimum_limit")
  maximumDeductible        Decimal? @map("maximum_deductible")
  requiredEndorsements     Json     @default("[]") @map("required_endorsements")
  requireAdditionalInsured Boolean  @default(false) @map("require_additional_insured")
  requireWaiverSubrogation Boolean  @default(false) @map("require_waiver_subrogation")
  minimumValidityDays      Int?     @map("minimum_validity_days")
  isMandatory              Boolean  @default(true) @map("is_mandatory")
  notes                    String?
  notesHe                  String?  @map("notes_he")

  template ComparisonTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@map("comparison_requirements")
}

model ComparisonAnalysis {
  id              String   @id @default(uuid())
  documentId      String   @map("document_id")
  templateId      String   @map("template_id")
  overallStatus   String   @map("overall_status")
  complianceScore Int      @map("compliance_score")
  results         Json
  analyzedAt      DateTime @default(now()) @map("analyzed_at")

  document ComparisonDocument  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  template ComparisonTemplate  @relation(fields: [templateId], references: [id])

  @@map("comparison_analyses")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id            String   @id @default(uuid())
  recipientId   String   @map("recipient_id")
  recipientType String   @map("recipient_type")
  type          String
  title         String
  message       String
  data          Json?
  isRead        Boolean  @default(false) @map("is_read")
  sentVia       String[] @map("sent_via")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

// ==================== AUDIT ====================

model AuditLog {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  action     String
  actorId    String?  @map("actor_id")
  actorType  String   @map("actor_type")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  actor User? @relation(fields: [actorId], references: [id])

  @@map("audit_log")
}

// ==================== INSURANCE PRODUCT CATALOG ====================

model InsuranceProduct {
  id              String   @id @default(uuid())
  code            String   @unique
  nameHe          String   @map("name_he")
  nameEn          String   @map("name_en")
  category        String   // property, liability, financial, engineering
  coverageTrigger String   @map("coverage_trigger") // occurrence, claims-made, discovery, all-risks, named-perils
  structure       Json     @default("{}") // {chapters, description}
  insurer         String?
  bitStandard     String?  @map("bit_standard") // e.g. "BIT 2019"
  description     String?
  descriptionHe   String?  @map("description_he")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  extensions         PolicyExtension[]
  exclusions         PolicyExclusion[]
  relationsFrom      CrossPolicyRelation[] @relation("FromProduct")
  relationsTo        CrossPolicyRelation[] @relation("ToProduct")
  sectorMappings     SectorProductMapping[]

  @@map("insurance_products")
}

model PolicyExtension {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  chapterCode  String?  @map("chapter_code") // e.g. "3" for Part A, "10" for Part B
  code         String   // e.g. "3.1", "10.1"
  nameHe       String   @map("name_he")
  nameEn       String   @map("name_en")
  description  String?
  defaultLimit Decimal? @map("default_limit")
  isFirstLoss  Boolean  @default(false) @map("is_first_loss")
  createdAt    DateTime @default(now()) @map("created_at")

  product InsuranceProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, code])
  @@map("policy_extensions")
}

model PolicyExclusion {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  chapterCode String?  @map("chapter_code")
  nameHe      String   @map("name_he")
  nameEn      String   @map("name_en")
  description String?
  isGeneral   Boolean  @default(true) @map("is_general")
  createdAt   DateTime @default(now()) @map("created_at")

  product InsuranceProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, nameEn])
  @@map("policy_exclusions")
}

model CrossPolicyRelation {
  id            String   @id @default(uuid())
  fromProductId String   @map("from_product_id")
  toProductId   String   @map("to_product_id")
  relationType  String   @map("relation_type") // complementary, bundled, residual
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")

  fromProduct InsuranceProduct @relation("FromProduct", fields: [fromProductId], references: [id], onDelete: Cascade)
  toProduct   InsuranceProduct @relation("ToProduct", fields: [toProductId], references: [id], onDelete: Cascade)

  @@unique([fromProductId, toProductId])
  @@map("cross_policy_relations")
}

model SectorProductMapping {
  id        String   @id @default(uuid())
  sector    String
  productId String   @map("product_id")
  necessity String   // mandatory, recommended, optional
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")

  product InsuranceProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([sector, productId])
  @@map("sector_product_mappings")
}

// ==================== INSURER POLICY COMPARISON ====================

// Master list of insurance companies
model Insurer {
  id        String   @id @default(uuid())
  code      String   @unique // e.g. "CLAL", "PHOENIX", "HAREL", "MIGDAL", "AYALON", "MENORAH", "SHLOMO"
  nameHe    String   @map("name_he")
  nameEn    String   @map("name_en")
  website   String?
  phone     String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  policies InsurerPolicy[]

  @@map("insurers")
}

// A specific insurer's version of a product type
model InsurerPolicy {
  id              String   @id @default(uuid())
  insurerId       String   @map("insurer_id")
  productCode     String   @map("product_code") // links to InsuranceProduct.code
  policyFormCode  String?  @map("policy_form_code") // insurer's own form number
  bitStandard     String?  @map("bit_standard") // e.g. "BIT 2019", "BIT 2016"
  editionYear     Int?     @map("edition_year") // e.g. 2019, 2018
  structure       Json     @default("{}") // chapters/parts info
  strengths       Json     @default("[]") // where this insurer is better than standard
  weaknesses      Json     @default("[]") // where this insurer falls short
  notableTerms    Json     @default("[]") @map("notable_terms") // unique conditions
  isMaster        Boolean  @default(false) @map("is_master") // true for the BIT standard reference
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  insurer    Insurer                  @relation(fields: [insurerId], references: [id], onDelete: Cascade)
  extensions InsurerPolicyExtension[]
  exclusions InsurerPolicyExclusion[]

  @@unique([insurerId, productCode])
  @@map("insurer_policies")
}

// Extension specific to an insurer's policy version
model InsurerPolicyExtension {
  id              String   @id @default(uuid())
  insurerPolicyId String   @map("insurer_policy_id")
  code            String   // section number e.g. "4.1", "4.2"
  nameHe          String   @map("name_he")
  nameEn          String   @map("name_en")
  description     String?
  descriptionHe   String?  @map("description_he")
  defaultLimit    Decimal? @map("default_limit")
  limitNotes      String?  @map("limit_notes") // e.g. "200,000 per event"
  isStandard      Boolean  @default(true) @map("is_standard") // exists in BIT standard?
  createdAt       DateTime @default(now()) @map("created_at")

  insurerPolicy InsurerPolicy @relation(fields: [insurerPolicyId], references: [id], onDelete: Cascade)

  @@unique([insurerPolicyId, code])
  @@map("insurer_policy_extensions")
}

// Exclusion specific to an insurer's policy version
model InsurerPolicyExclusion {
  id              String   @id @default(uuid())
  insurerPolicyId String   @map("insurer_policy_id")
  code            String   // section number e.g. "3.1", "3.2"
  nameHe          String   @map("name_he")
  nameEn          String   @map("name_en")
  description     String?
  descriptionHe   String?  @map("description_he")
  isStandard      Boolean  @default(true) @map("is_standard") // exists in BIT standard?
  createdAt       DateTime @default(now()) @map("created_at")

  insurerPolicy InsurerPolicy @relation(fields: [insurerPolicyId], references: [id], onDelete: Cascade)

  @@unique([insurerPolicyId, code])
  @@map("insurer_policy_exclusions")
}

// ==================== DYNAMIC QUESTIONNAIRE ====================

// Questionnaire template (one per sector)
model QuestionnaireTemplate {
  id            String   @id @default(uuid())
  sector        String   @unique
  sectorHe      String   @map("sector_he")
  description   String?
  descriptionHe String?  @map("description_he")
  version       String   @default("1.0")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  sections QuestionnaireSection[]
  rules    CoverageRule[]

  @@map("questionnaire_templates")
}

// Section groups questions
model QuestionnaireSection {
  id            String   @id @default(uuid())
  templateId    String   @map("template_id")
  title         String
  titleHe       String   @map("title_he")
  description   String?
  descriptionHe String?  @map("description_he")
  order         Int      @default(0)
  showIf        Json?    @map("show_if")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  template  QuestionnaireTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  questions Question[]

  @@map("questionnaire_sections")
}

// Individual question
model Question {
  id             String   @id @default(uuid())
  sectionId      String   @map("section_id")
  questionId     String   @map("question_id")
  label          String
  labelHe        String   @map("label_he")
  description    String?
  descriptionHe  String?  @map("description_he")
  type           String   // boolean, number, select, multiselect, text, date, currency
  options        Json?    // for select types: [{value, label, labelHe}]
  placeholder    String?
  placeholderHe  String?  @map("placeholder_he")
  required       Boolean  @default(false)
  order          Int      @default(0)
  min            Float?
  max            Float?
  showIf         Json?    @map("show_if") // [{questionId, operator, value}]
  riskWeight     Float?   @default(0) @map("risk_weight")
  policyAffinity String[] @map("policy_affinity") // which policies this affects
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  section QuestionnaireSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([sectionId, questionId])
  @@map("questions")
}

// Coverage rule for dynamic recommendations
model CoverageRule {
  id            String   @id @default(uuid())
  templateId    String   @map("template_id")
  name          String
  nameHe        String   @map("name_he")
  description   String?
  descriptionHe String?  @map("description_he")
  priority      Int      @default(50)
  isActive      Boolean  @default(true) @map("is_active")
  conditions    Json     // [{field, operator, value}]
  actions       Json     // [{type, policyType, multiplier, endorsement, amount, mandatory}]
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  template QuestionnaireTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@map("coverage_rules")
}
